<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Now Playing • Last.fm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #ff7cf6 0, transparent 55%),
                  radial-gradient(circle at bottom, #6bc9ff 0, #050815 65%);
      color: #f5f5f5;
    }

    .wrapper {
      width: 100%;
      max-width: 1100px;
      padding: 24px;
    }

    .player-card {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 24px;
      padding: 24px;
      border-radius: 24px;
      background: rgba(5, 10, 30, 0.9);
      backdrop-filter: blur(18px);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    @media (max-width: 800px) {
      .player-card {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .artwork-shell {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, #ffffff22, #000000aa);
      min-height: 280px;
      isolation: isolate;
    }

    .artwork-bg {
      position: absolute;
      inset: -20px;
      background-position: center;
      background-size: cover;
      filter: blur(18px) saturate(1.3);
      opacity: 0.7;
      transform: scale(1.08);
    }

    .artwork-foreground {
      position: relative;
      z-index: 1;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .artwork-square {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 18px;
      background-position: center;
      background-size: cover;
      background-repeat: no-repeat;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .meta {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .pill-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 4px 10px;
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #e0e7ff;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 16px rgba(34, 197, 94, 0.9);
    }

    .status-dot.paused {
      background: #9ca3af;
      box-shadow: none;
    }

    .title {
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
    }

    .artist {
      font-size: 18px;
      color: #cbd5f5;
    }

    .album {
      font-size: 14px;
      color: #9ca3c7;
    }

    .lastfm-link {
      font-size: 13px;
      color: #93c5fd;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      opacity: 0.9;
    }

    .lastfm-link:hover {
      opacity: 1;
      text-decoration: underline;
    }

    .visualizer {
      display: flex;
      gap: 4px;
      height: 38px;
      align-items: flex-end;
      margin-top: 6px;
    }

    .visualizer span {
      width: 5px;
      border-radius: 999px;
      background: linear-gradient(to top, #4ade80, #a855f7);
      animation: bar 1.1s infinite ease-in-out;
      transform-origin: bottom;
    }

    .visualizer span:nth-child(2) { animation-delay: 0.1s; }
    .visualizer span:nth-child(3) { animation-delay: 0.2s; }
    .visualizer span:nth-child(4) { animation-delay: 0.3s; }
    .visualizer span:nth-child(5) { animation-delay: 0.45s; }
    .visualizer span:nth-child(6) { animation-delay: 0.6s; }
    .visualizer span:nth-child(7) { animation-delay: 0.75s; }
    .visualizer.paused span {
      animation: none;
      height: 12%;
      opacity: 0.4;
    }

    @keyframes bar {
      0%, 100% { height: 15%; opacity: 0.6; }
      40% { height: 100%; opacity: 1; }
      60% { height: 55%; opacity: 0.8; }
    }

    .video-shell {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .video-label-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .video-label {
      font-size: 13px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #9ca3c7;
    }

    .video-note {
      font-size: 11px;
      color: #6b7280;
      text-align: right;
    }

    .video-frame-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at top, #1f2937, #020617);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .video-frame-wrapper iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    .error,
    .loading {
      font-size: 13px;
      color: #9ca3c7;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="player-card">
      <!-- LEFT: Artwork + Track Meta -->
      <div class="artwork-shell">
        <div id="artwork-bg" class="artwork-bg"></div>
        <div class="artwork-foreground">
          <div id="artwork-square" class="artwork-square"></div>
        </div>
      </div>

      <!-- RIGHT: Text + Visualizer + Video -->
      <div class="meta">
        <div class="pill-row">
          <div class="pill-row">
            <div id="status-dot" class="status-dot"></div>
            <div id="status-text" class="pill">Loading current track…</div>
          </div>
          <div class="pill">Last.fm Live</div>
        </div>

        <div>
          <div id="track-title" class="title">—</div>
          <div id="track-artist" class="artist">—</div>
          <div id="track-album" class="album"></div>
        </div>

        <div class="visualizer" id="visualizer">
          <span></span><span></span><span></span><span></span>
          <span></span><span></span><span></span>
        </div>

        <a id="lastfm-link" class="lastfm-link" href="#" target="_blank" rel="noopener">
          View on Last.fm
        </a>

        <div class="video-shell">
          <div class="video-label-row">
            <div class="video-label">Music video</div>
            <div id="video-note" class="video-note">
              Pulling from YouTube based on artist + track title
            </div>
          </div>

          <div class="video-frame-wrapper">
            <iframe
              id="video-frame"
              src=""
              title="Music video"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
            ></iframe>
          </div>

          <div id="info-message" class="loading"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const LASTFM_API_KEY = "f7100e74c6d216539a6bd2413fb465c4";
    const LASTFM_USER = "cQloud";
    const YT_API_KEY = "AIzaSyAHhbjnoTVTVBjavcpS5MUhJxNqHEwRUxQ";

    // poll interval (ms)
    const POLL_MS = 15000;

    // ====== DOM HANDLES ======
    const statusText = document.getElementById("status-text");
    const statusDot = document.getElementById("status-dot");
    const titleEl = document.getElementById("track-title");
    const artistEl = document.getElementById("track-artist");
    const albumEl = document.getElementById("track-album");
    const visualizer = document.getElementById("visualizer");
    const lastfmLink = document.getElementById("lastfm-link");
    const infoMessage = document.getElementById("info-message");
    const videoFrame = document.getElementById("video-frame");
    const artworkBg = document.getElementById("artwork-bg");
    const artworkSquare = document.getElementById("artwork-square");

    // remember last track to avoid reloading the same video
    let lastTrackKey = null;

    lastfmLink.href = "https://www.last.fm/user/" + encodeURIComponent(LASTFM_USER);

    async function fetchCurrentTrack() {
      try {
        infoMessage.textContent = "";
        const url =
          "https://ws.audioscrobbler.com/2.0/?" +
          new URLSearchParams({
            method: "user.getrecenttracks",
            user: LASTFM_USER,
            api_key: LASTFM_API_KEY,
            format: "json",
            limit: "1"
          }).toString();

        const res = await fetch(url);
        if (!res.ok) throw new Error("Last.fm request failed: " + res.status);
        const data = await res.json();

        const tracks = data.recenttracks && data.recenttracks.track;
        if (!tracks || tracks.length === 0) {
          setEmptyState();
          return;
        }

        const track = Array.isArray(tracks) ? tracks[0] : tracks;

        const isNowPlaying =
          track["@attr"] && track["@attr"].nowplaying === "true";

        const artist =
          (track.artist && track.artist["#text"]) || "Unknown artist";
        const title = track.name || "Unknown title";
        const album =
          track.album && track.album["#text"] ? track.album["#text"] : "";

        const imageArray = track.image || [];
        const largeImage =
          imageArray.length > 0
            ? imageArray[imageArray.length - 1]["#text"]
            : "";

        const trackKey = artist + " - " + title;
        const trackChanged = trackKey !== lastTrackKey;
        lastTrackKey = trackKey;

        updateTrackUI({ artist, title, album, largeImage, isNowPlaying });

        if (trackChanged) {
          await fetchYouTubeVideo({ artist, title, isNowPlaying });
        }
      } catch (e) {
        console.error(e);
        infoMessage.textContent =
          "Could not load data from Last.fm. Check API key, username, or CORS.";
        setErrorState();
      }
    }

    function updateTrackUI({ artist, title, album, largeImage, isNowPlaying }) {
      titleEl.textContent = title;
      artistEl.textContent = artist;
      albumEl.textContent = album ? "on " + album : "";

      if (largeImage) {
        artworkBg.style.backgroundImage = "url('" + largeImage + "')";
        artworkSquare.style.backgroundImage = "url('" + largeImage + "')";
      } else {
        artworkBg.style.backgroundImage =
          "radial-gradient(circle at 20% 20%, #4b5563, #020617)";
        artworkSquare.style.backgroundImage =
          "radial-gradient(circle at 20% 20%, #4b5563, #020617)";
      }

      if (isNowPlaying) {
        statusText.textContent = "Now playing";
        statusDot.classList.remove("paused");
        visualizer.classList.remove("paused");
      } else {
        statusText.textContent = "Last scrobbled";
        statusDot.classList.add("paused");
        visualizer.classList.add("paused");
      }
    }

    function setEmptyState() {
      titleEl.textContent = "Nothing here yet";
      artistEl.textContent = "No scrobbles available";
      albumEl.textContent = "";
      statusText.textContent = "Offline";
      statusDot.classList.add("paused");
      visualizer.classList.add("paused");
      infoMessage.textContent = "Start playing something on a connected service.";
      videoFrame.src = "";
    }

    function setErrorState() {
      statusText.textContent = "Error";
      statusDot.classList.add("paused");
      visualizer.classList.add("paused");
      videoFrame.src = "";
    }

    async function fetchYouTubeVideo({ artist, title, isNowPlaying }) {
      try {
        const query = artist + " - " + title + " official music video";
        const url =
          "https://www.googleapis.com/youtube/v3/search?" +
          new URLSearchParams({
            part: "snippet",
            type: "video",
            maxResults: "1",
            q: query,
            key: YT_API_KEY
          }).toString();

        const res = await fetch(url);
        if (!res.ok) throw new Error("YouTube request failed: " + res.status);
        const data = await res.json();

        if (!data.items || data.items.length === 0) {
          infoMessage.textContent = "No matching music video found on YouTube.";
          videoFrame.src = "";
          return;
        }

        const videoId = data.items[0].id.videoId;
        const autoplay = isNowPlaying ? "1" : "0";

        videoFrame.src =
          "https://www.youtube.com/embed/" +
          videoId +
          "?autoplay=" +
          autoplay +
          "&mute=1&rel=0";
        infoMessage.textContent = "";
      } catch (e) {
        console.error(e);
        infoMessage.textContent =
          "Could not load video from YouTube. Check API key or quota.";
        videoFrame.src = "";
      }
    }

    fetchCurrentTrack();
    setInterval(fetchCurrentTrack, POLL_MS);
  </script>
</body>
</html>
